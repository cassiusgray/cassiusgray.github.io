<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World Golf Index Handicap Calculator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1, h2 {
            color: #2e6b38;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: white;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #2e6b38;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .input-section, .results-section {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .input-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        input, select, button {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        button {
            background-color: #2e6b38;
            color: white;
            cursor: pointer;
            border: none;
            padding: 10px 15px;
        }
        button:hover {
            background-color: #1e4d26;
        }
        .handicap-display {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            color: #2e6b38;
        }
        .info-box {
            background-color: #e8f4ea;
            border-left: 4px solid #2e6b38;
            padding: 15px;
            margin: 15px 0;
        }
        .delete-btn {
            background-color: #d9534f;
            color: white;
            cursor: pointer;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
        }
        .delete-btn:hover {
            background-color: #c9302c;
        }
        .score-differential {
            font-weight: bold;
        }
        .best-rounds {
            background-color: #e8f4ea;
        }
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
        }
        .loading::after {
            content: "";
            width: 20px;
            height: 20px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #2e6b38;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .player-select {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            margin-right: 10px;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background-color: #ddd;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background-color: #2e6b38;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #settings-section {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status-message {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>World Golf Index Handicap Calculator</h1>
    
    <div id="settings-section">
        <h2>Google Sheets Connection</h2>
        <div class="input-row">
            <input type="text" id="sheet-id" placeholder="Google Sheet ID" style="flex-grow: 1;">
            <button id="connect-sheet-btn">Connect</button>
        </div>
        <div class="info-box">
            <strong>How to connect:</strong>
            <ol>
                <li>Create a Google Sheet with the required structure (see below)</li>
                <li>Make the sheet public (File → Share → Anyone with the link → Viewer)</li>
                <li>Copy the Sheet ID from the URL (the long string between /d/ and /edit)</li>
                <li>Paste it above and click Connect</li>
            </ol>
            <strong>Required Sheet Structure:</strong>
            <ul>
                <li>Sheet named "Rounds" with columns: Date, Player Name, Course Name, Slope Rating, Course Rating, Adjusted Gross Score, Score Differential</li>
                <li>Sheet named "Players" with column: Name</li>
                <li>Sheet named "Handicaps" with columns: Player Name, Rounds Count, Handicap Index, Best Rounds Used, Last Updated</li>
            </ul>
        </div>
        <div id="connection-status" class="status-message"></div>
    </div>
    
    <div class="tabs">
        <div class="tab active" data-tab="add-round">Add Round</div>
        <div class="tab" data-tab="view-rounds">View Rounds</div>
        <div class="tab" data-tab="handicaps">Handicaps</div>
    </div>
    
    <div class="container">
        <div id="add-round-tab" class="tab-content active">
            <div class="input-section">
                <h2>Add New Round</h2>
                <div class="input-row">
                    <select id="player-select" class="player-select">
                        <option value="">Select Player</option>
                    </select>
                    <input type="date" id="date-input" placeholder="Date">
                </div>
                <div class="input-row">
                    <input type="text" id="course-input" placeholder="Course Name">
                    <input type="number" id="slope-input" placeholder="Slope Rating" min="55" max="155">
                    <input type="number" id="course-rating-input" placeholder="Course Rating" step="0.1" min="60" max="90">
                    <input type="number" id="score-input" placeholder="Adjusted Gross Score" min="30" max="200">
                </div>
                <button id="add-round-btn">Add Round</button>
                <div class="info-box">
                    <strong>Note:</strong> Adjusted Gross Score should already have the maximum of Net Double Bogey per hole applied.
                </div>
                <div id="add-status" class="status-message"></div>
            </div>
        </div>
        
        <div id="view-rounds-tab" class="tab-content">
            <div class="results-section">
                <h2>All Rounds</h2>
                <div class="input-row">
                    <select id="filter-player-select" class="player-select">
                        <option value="">All Players</option>
                    </select>
                    <button id="refresh-rounds-btn">Refresh</button>
                </div>
                <div id="rounds-loading" class="loading" style="display: none;"></div>
                <table id="rounds-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Player</th>
                            <th>Course</th>
                            <th>Slope Rating</th>
                            <th>Course Rating</th>
                            <th>Adj. Gross Score</th>
                            <th>Score Differential</th>
                        </tr>
                    </thead>
                    <tbody id="rounds-body">
                        <!-- Rounds will be added here dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="handicaps-tab" class="tab-content">
            <div class="results-section">
                <h2>Player Handicaps</h2>
                <button id="refresh-handicaps-btn">Refresh</button>
                <div id="handicaps-loading" class="loading" style="display: none;"></div>
                <table id="handicaps-table">
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>Rounds</th>
                            <th>Handicap Index</th>
                            <th>Best Rounds Used</th>
                            <th>Last Updated</th>
                        </tr>
                    </thead>
                    <tbody id="handicaps-body">
                        <!-- Handicaps will be added here dynamically -->
                    </tbody>
                </table>
                
                <div class="info-box">
                    <strong>How it works:</strong>
                    <ul>
                        <li>Score Differential = (113 ÷ Slope Rating) × (Adjusted Gross Score - Course Rating)</li>
                        <li>For fewer than 20 rounds, we use the best differentials based on this table:
                            <ul>
                                <li>3 rounds or fewer: No handicap calculated yet</li>
                                <li>4-6 rounds: Lowest 1 differential</li>
                                <li>7-8 rounds: Lowest 2 differentials</li>
                                <li>9-11 rounds: Lowest 3 differentials</li>
                                <li>12-14 rounds: Lowest 4 differentials</li>
                                <li>15-16 rounds: Lowest 5 differentials</li>
                                <li>17-18 rounds: Lowest 6 differentials</li>
                                <li>19 rounds: Lowest 7 differentials</li>
                                <li>20 rounds: Lowest 8 differentials</li>
                            </ul>
                        </li>
                        <li>The Handicap Index is the average of these best differentials multiplied by 0.96 (rounded to 1 decimal place)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let sheetId = '';
        let players = [];
        
        // DOM elements
        const sheetIdInput = document.getElementById('sheet-id');
        const connectSheetBtn = document.getElementById('connect-sheet-btn');
        const connectionStatus = document.getElementById('connection-status');
        const dateInput = document.getElementById('date-input');
        const playerSelect = document.getElementById('player-select');
        const filterPlayerSelect = document.getElementById('filter-player-select');
        const courseInput = document.getElementById('course-input');
        const slopeInput = document.getElementById('slope-input');
        const courseRatingInput = document.getElementById('course-rating-input');
        const scoreInput = document.getElementById('score-input');
        const addRoundBtn = document.getElementById('add-round-btn');
        const addStatus = document.getElementById('add-status');
        const roundsBody = document.getElementById('rounds-body');
        const handicapsBody = document.getElementById('handicaps-body');
        const refreshRoundsBtn = document.getElementById('refresh-rounds-btn');
        const refreshHandicapsBtn = document.getElementById('refresh-handicaps-btn');
        const roundsLoading = document.getElementById('rounds-loading');
        const handicapsLoading = document.getElementById('handicaps-loading');
        
        // Set default date to today
        dateInput.valueAsDate = new Date();
        
        // Check for saved Sheet ID
        const savedSheetId = localStorage.getItem('golfHandicapSheetId');
        if (savedSheetId) {
            sheetIdInput.value = savedSheetId;
            sheetId = savedSheetId;
            connectToSheet();
        }
        
        // Add event listeners
        connectSheetBtn.addEventListener('click', function() {
            sheetId = sheetIdInput.value.trim();
            localStorage.setItem('golfHandicapSheetId', sheetId);
            connectToSheet();
        });
        
        addRoundBtn.addEventListener('click', addRound);
        refreshRoundsBtn.addEventListener('click', fetchRounds);
        refreshHandicapsBtn.addEventListener('click', fetchHandicaps);
        
        // Tab functionality
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active class from all tabs
                tabs.forEach(t => t.classList.remove('active'));
                
                // Add active class to clicked tab
                this.classList.add('active');
                
                // Hide all tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Show content for clicked tab
                const tabId = this.getAttribute('data-tab');
                document.getElementById(`${tabId}-tab`).classList.add('active');
                
                // Refresh data when switching to tabs
                if (tabId === 'view-rounds') {
                    fetchRounds();
                } else if (tabId === 'handicaps') {
                    fetchHandicaps();
                }
            });
        });
        
        // Function to connect to Google Sheet
        function connectToSheet() {
            if (!sheetId) {
                showConnectionStatus('Please enter a valid Google Sheet ID', 'error');
                return;
            }
            
            showConnectionStatus('Connecting to Google Sheet...', '');
            
            // Fetch players first
            fetchPlayers()
                .then(() => {
                    showConnectionStatus('Connected successfully!', 'success');
                    playerSelect.disabled = false;
                    filterPlayerSelect.disabled = false;
                    
                    // Fetch initial data
                    fetchRounds();
                    fetchHandicaps();
                })
                .catch(error => {
                    console.error('Connection error:', error);
                    showConnectionStatus('Failed to connect. Make sure the Sheet ID is correct and the sheet is public.', 'error');
                });
        }
        
        // Function to show connection status
        function showConnectionStatus(message, type) {
            connectionStatus.textContent = message;
            connectionStatus.className = 'status-message';
            if (type) {
                connectionStatus.classList.add(type);
            }
        }
        
        // Function to fetch players from Google Sheet
        function fetchPlayers() {
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=Players`;
            
            return fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch players');
                    }
                    return response.text();
                })
                .then(csv => {
                    // Parse CSV
                    const rows = csv.split('\n');
                    players = [];
                    
                    // Skip header row
                    for (let i = 1; i < rows.length; i++) {
                        const playerName = rows[i].replace(/"/g, '');
                        if (playerName.trim()) {
                            players.push(playerName);
                        }
                    }
                    
                    // Update player selects
                    updatePlayerSelects();
                });
        }
        
        // Function to update player selects
        function updatePlayerSelects() {
            // Clear existing options except the first one
            while (playerSelect.options.length > 1) {
                playerSelect.remove(1);
            }
            
            while (filterPlayerSelect.options.length > 1) {
                filterPlayerSelect.remove(1);
            }
            
            // Add player options
            players.forEach(player => {
                const option1 = document.createElement('option');
                option1.value = player;
                option1.textContent = player;
                playerSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = player;
                option2.textContent = player;
                filterPlayerSelect.appendChild(option2);
            });
        }
        
        // Function to add a new round
        function addRound() {
            // Validate inputs
            const player = playerSelect.value;
            const date = dateInput.value;
            const course = courseInput.value;
            const slope = slopeInput.value;
            const courseRating = courseRatingInput.value;
            const score = scoreInput.value;
            
            if (!player || !date || !course || !slope || !courseRating || !score) {
                addStatus.textContent = 'Please fill in all fields';
                addStatus.className = 'status-message error';
                return;
            }
            
            // Calculate differential
            const differential = ((113 / parseFloat(slope)) * (parseFloat(score) - parseFloat(courseRating))).toFixed(1);
            
            // Create Google Sheets API URL for appending data
            const formattedDate = new Date(date).toLocaleDateString('en-US');
            const sheetValues = [formattedDate, player, course, slope, courseRating, score, differential];
            const appendUrl = `https://docs.google.com/forms/d/e/YOUR_FORM_ID/formResponse?` +
                `entry.123=${encodeURIComponent(formattedDate)}&` +
                `entry.456=${encodeURIComponent(player)}&` +
                `entry.789=${encodeURIComponent(course)}&` +
                `entry.101=${encodeURIComponent(slope)}&` +
                `entry.102=${encodeURIComponent(courseRating)}&` +
                `entry.103=${encodeURIComponent(score)}&` +
                `entry.104=${encodeURIComponent(differential)}`;
            
            // Show status message
            addStatus.textContent = 'For this to work, you need to create a Google Form that submits to your sheet. See instructions in README.';
            addStatus.className = 'status-message';
            
            // Clear form inputs
            courseInput.value = '';
            scoreInput.value = '';
            
            // Here, you would normally submit the data, but since we can't directly write to Google Sheets
            // without authentication, we're showing what would need to be done
        }
        
        // Function to fetch rounds from Google Sheet
        function fetchRounds() {
            if (!sheetId) return;
            
            roundsLoading.style.display = 'flex';
            
            const selectedPlayer = filterPlayerSelect.value;
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=Rounds`;
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch rounds');
                    }
                    return response.text();
                })
                .then(csv => {
                    // Parse CSV
                    const rows = csv.split('\n');
                    
                    // Clear existing rows
                    roundsBody.innerHTML = '';
                    
                    // Skip header row
                    for (let i = 1; i < rows.length; i++) {
                        const cells = parseCSVRow(rows[i]);
                        
                        // Check if we need to filter by player
                        if (selectedPlayer && cells[1] !== selectedPlayer) {
                            continue;
                        }
                        
                        const row = document.createElement('tr');
                        
                        // Date might be in various formats, try to format it nicely
                        const dateStr = cells[0].replace(/"/g, '');
                        let formattedDate = dateStr;
                        try {
                            const date = new Date(dateStr);
                            if (!isNaN(date.getTime())) {
                                formattedDate = date.toLocaleDateString();
                            }
                        } catch (e) {
                            // Keep original string if date parsing fails
                        }
                        
                        row.innerHTML = `
                            <td>${formattedDate}</td>
                            <td>${cells[1]}</td>
                            <td>${cells[2]}</td>
                            <td>${cells[3]}</td>
                            <td>${cells[4]}</td>
                            <td>${cells[5]}</td>
                            <td class="score-differential">${cells[6]}</td>
                        `;
                        
                        roundsBody.appendChild(row);
                    }
                })
                .catch(error => {
                    console.error('Error fetching rounds:', error);
                })
                .finally(() => {
                    roundsLoading.style.display = 'none';
                });
        }
        
        // Function to fetch handicaps from Google Sheet
        function fetchHandicaps() {
            if (!sheetId) return;
            
            handicapsLoading.style.display = 'flex';
            
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=Handicaps`;
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch handicaps');
                    }
                    return response.text();
                })
                .then(csv => {
                    // Parse CSV
                    const rows = csv.split('\n');
                    
                    // Clear existing rows
                    handicapsBody.innerHTML = '';
                    
                    // Skip header row
                    for (let i = 1; i < rows.length; i++) {
                        const cells = parseCSVRow(rows[i]);
                        
                        const row = document.createElement('tr');
                        
                        // Format date
                        const dateStr = cells[4].replace(/"/g, '');
                        let formattedDate = dateStr;
                        try {
                            const date = new Date(dateStr);
                            if (!isNaN(date.getTime())) {
                                formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                            }
                        } catch (e) {
                            // Keep original string if date parsing fails
                        }
                        
                        row.innerHTML = `
                            <td>${cells[0]}</td>
                            <td>${cells[1]}</td>
                            <td>${cells[2]}</td>
                            <td>${cells[3]}</td>
                            <td>${formattedDate}</td>
                        `;
                        
                        handicapsBody.appendChild(row);
                    }
                })
                .catch(error => {
                    console.error('Error fetching handicaps:', error);
                })
                .finally(() => {
                    handicapsLoading.style.display = 'none';
                });
        }
        
        // Helper function to parse CSV row handling quoted values
        function parseCSVRow(row) {
            const cells = [];
            let inQuotes = false;
            let currentCell = '';
            
            for (let i = 0; i < row.length; i++) {
                const char = row[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    cells.push(currentCell.replace(/"/g, ''));
                    currentCell = '';
                } else {
                    currentCell += char;
                }
            }
            
            cells.push(currentCell.replace(/"/g, ''));
            return cells;
        }
    </script>
</body>
</html>
